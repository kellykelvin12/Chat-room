<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Admin Dashboard - Gossip of Athi River Secondary School</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="{{ url_for('static', filename='admin.js') }}"></script>
    <style>
        .identity-control {
            background: var(--dark-gray);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .identity-control select, .identity-control button {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
        }
        .identity-control button {
            cursor: pointer;
        }
        .btn-reveal {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }
        .btn-reverse {
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
        }
    </style>
    <script>
    </script>
    <script src="{{ url_for('static', filename='admin_settings.js') }}"></script>
    </script>

    <style>
        /* Pagination active page */
        .active-page {
            background: var(--light-blue);
            color: #fff;
            border-radius: 4px;
        }

        /* Simple modal */
        .confirm-modal {
            position: fixed;
            left: 0; top: 0; right:0; bottom:0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .confirm-modal .box {
            background: var(--black);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 480px;
            text-align: center;
            border: 1px solid var(--medium-gray);
        }

        /* Toast */
        .toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 6px;
            display: none;
            z-index: 1200;
        }
        /* Private chats unread badge */
        .support-badge {
            display: inline-block;
            min-width: 22px;
            padding: 2px 6px;
            background: #e74c3c;
            color: #fff;
            border-radius: 12px;
            font-size: 0.9em;
            vertical-align: middle;
            margin-left: 6px;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ†Ô∏è Admin Dashboard</h1>
            <p class="tagline">Gossip of Athi River Secondary School - Administrator Panel</p>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('users')">üë• User Management</div>
            <div class="nav-tab" onclick="showSection('topics')">üìù Topic Management</div>
            <div class="nav-tab" onclick="showSection('relationships')">üíï Relationships</div>
            <div class="nav-tab" onclick="showSection('moderation')">üõ°Ô∏è Content Moderation</div>
            <a class="nav-tab" href="{{ url_for('admin_private_chats') }}" style="position:relative;text-decoration:none;color:inherit;">
                üí¨ Private Chats
                <span id="support-badge" class="support-badge {% if unread_private_count == 0 %}hidden{% endif %}">
                    {{ unread_private_count if unread_private_count > 0 else '' }}
                </span>
            </a>
        </div>

        <!-- User Management -->
        <div id="users" class="admin-section active">
            <h3>üë• User Management</h3>
            
            <!-- Identity Management -->
            <div class="admin-subsection">
                <h4>üîì Identity Management</h4>
                <!-- Topic Identity Control -->
            <div class="identity-control">
                <h5>Topic Identity Control</h5>
                <form id="identityForm">
                    <div class="form-group">
                        <label for="topicSelect">Select Topic:</label>
                        <select id="topicSelect" name="topic_id" class="form-control">
                            {% for topic in topics %}
                                <option value="{{ topic.id|string }}">{{ topic.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userSelect">Select User:</label>
                        <select id="userSelect" name="user_id" class="form-control">
                            {% for user in approved_users %}
                                <option value="{{ user.id|string }}">{{ user.name }} ({{ user.username }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn-reveal" onclick="handleIdentityAction('force_reveal')">Force Identity Reveal</button>
                    <button type="button" class="btn-reverse" onclick="handleIdentityAction('remove_force')">Reverse Identity Reveal</button>
                </form>
            </div>

            <!-- Relationship Identity Control -->
            <div class="identity-control">
                <h5>Relationship Identity Control</h5>
                <form id="relationshipIdentityForm">
                    <div class="form-group">
                        <label for="relationshipSelect">Select Relationship:</label>
                        <select id="relationshipSelect" name="relationship_id" class="form-control">
                            {% for relationship in relationships %}
                                <option value="{{ relationship.id|string }}">{{ relationship.person1 }}{% if relationship.person2 %} & {{ relationship.person2 }}{% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relationshipUserSelect">Select User:</label>
                        <select id="relationshipUserSelect" name="user_id" class="form-control">
                            {% for user in approved_users %}
                                <option value="{{ user.id|string }}">{{ user.name }} ({{ user.username }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="button" class="btn-reveal" onclick="handleRelationshipIdentityAction('force_reveal')">Force Identity Reveal</button>
                    <button type="button" class="btn-reverse" onclick="handleRelationshipIdentityAction('remove_force')">Reverse Identity Reveal</button>
                </form>
            </div>
            </div>

            <!-- Pending Users -->
            <div class="admin-subsection">
                <h4>‚è≥ Pending Approvals ({{ pending_users|length }})</h4>
                {% if pending_users %}
                    {% for user in pending_users %}
                    <div class="user-card">
                        <div class="user-info">
                            <p><strong>Name:</strong> {{ user.name }}</p>
                            <p><strong>Class:</strong> {{ user.class_name }}</p>
                                <p><strong>Stream:</strong> {{ user.stream }}</p>
                                <p><strong>Phone:</strong> {{ user.phone_number }}</p>
                                <p><strong>Instagram:</strong> {{ user.instagram_username }}</p>
                                <p>
                                    <strong>Password (hash):</strong>
                                    <span class="masked-field">
                                        <code>{{ user.password[:12] }}...</code>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.password }}')">Show</button>
                                    </span>
                                </p>
                                <p>
                                    <strong>Email Password:</strong>
                                    <span class="masked-field">
                                        <span>{{ user.email_password[:3] if user.email_password else '' }}***</span>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.email_password if user.email_password else '' }}')">Show</button>
                                    </span>
                                </p>
                                <p>
                                    <strong>Instagram Password:</strong>
                                    <span class="masked-field">
                                        <span>{{ user.instagram_password[:3] if user.instagram_password else '' }}***</span>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.instagram_password if user.instagram_password else '' }}')">Show</button>
                                    </span>
                                </p>
                            <p><strong>Username:</strong> {{ user.username }}</p>
                            <p><strong>Email:</strong> {{ user.email }}</p>
                            <p><strong>Registered:</strong> {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-success" onclick="approveUser('{{ user.id }}')">‚úÖ Approve</button>
                            <button class="btn-danger" onclick="rejectUser('{{ user.id }}')">‚ùå Reject</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No pending users at the moment.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Approved Users -->
            <div class="admin-subsection">
                <h4>‚úÖ Approved Users ({{ approved_users|length }})</h4>
                {% if approved_users %}
                    {% for user in approved_users %}
                    <div class="user-card">
                        <div class="user-info">
                            <p><strong>Name:</strong> {{ user.name }}</p>
                            <p><strong>Username:</strong> {{ user.username }}</p>
                                <p><strong>Class:</strong> {{ user.class_name }}</p>
                                <p><strong>Stream:</strong> {{ user.stream }}</p>
                                <p><strong>Phone:</strong> {{ user.phone_number }}</p>
                                <p><strong>Instagram:</strong> {{ user.instagram_username }}</p>
                                <p>
                                    <strong>Password (hash):</strong>
                                    <span class="masked-field">
                                        <code>{{ user.password[:12] }}...</code>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.password }}')">Show</button>
                                    </span>
                                </p>
                                <p>
                                    <strong>Email Password:</strong>
                                    <span class="masked-field">
                                        <span>{{ user.email_password[:3] if user.email_password else '' }}***</span>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.email_password if user.email_password else '' }}')">Show</button>
                                    </span>
                                </p>
                                <p>
                                    <strong>Instagram Password:</strong>
                                    <span class="masked-field">
                                        <span>{{ user.instagram_password[:3] if user.instagram_password else '' }}***</span>
                                        <button class="btn-sm btn-reveal" onclick="revealField(this, '{{ user.instagram_password if user.instagram_password else '' }}')">Show</button>
                                    </span>
                                </p>
                                <p><strong>Last Login:</strong> {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-danger" onclick="blockUser('{{ user.id }}')">üö´ Block User</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No approved users yet.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Blocked Users -->
            <div class="admin-subsection">
                <h4>üö´ Blocked Users ({{ blocked_users|length }})</h4>
                {% if blocked_users %}
                    {% for user in blocked_users %}
                    <div class="user-card">
                        <div class="user-info">
                            <p><strong>Name:</strong> {{ user.name }}</p>
                            <p><strong>Username:</strong> {{ user.username }}</p>
                            <p><strong>Block Reason:</strong> {{ user.block_reason or 'No reason provided' }}</p>
                            <p><strong>Blocked Since:</strong> {{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Unknown' }}</p>
                        </div>
                        <div class="user-actions">
                            <button class="btn-success" onclick="unblockUser('{{ user.id }}')">üîì Unblock</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <p>No blocked users.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Topic Forced Reveals -->
            <div class="admin-subsection">
                <h4>üîí Topic Forced Identity Reveals ({{ pagination.fi_total }})</h4>
                {% if forced_identities %}
                    {% for fi in forced_identities %}
                        <div class="user-card">
                            <div class="user-info">
                                <p><strong>Topic:</strong> {{ topics_by_id[fi.topic_id].name if topics_by_id.get(fi.topic_id) else fi.topic_id }}</p>
                                <p><strong>User:</strong> {{ users_by_id[fi.user_id].name if users_by_id.get(fi.user_id) else fi.user_id }}</p>
                                <p><strong>Enforced by:</strong> {{ users_by_id[fi.created_by].name if users_by_id.get(fi.created_by) else fi.created_by }}</p>
                                <p><small>ID: {{ fi.id }}</small></p>
                            </div>
                            <div class="user-actions">
                                <button class="btn-reverse" onclick="confirmRemoveForced('{{ fi.user_id }}','{{ fi.topic_id }}')">Remove</button>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Pagination controls -->
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
                        {% for p in range(1, pagination.fi_pages + 1) %}
                            <a href="{{ url_for('admin') }}?fi_page={{ p }}" class="btn-secondary {% if p==pagination.fi_page %}active-page{% endif %}" style="padding:6px 10px;">{{ p }}</a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No forced identity reveals in topics.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Relationship Forced Reveals -->
            <div class="admin-subsection">
                <h4>üîí Relationship Forced Identity Reveals ({{ pagination.rfi_total }})</h4>
                {% if relationship_forced_identities %}
                    {% for rfi in relationship_forced_identities %}
                        <div class="user-card">
                            <div class="user-info">
                                {% set relationship = relationships_by_id.get(rfi.relationship_id) %}
                                <p><strong>Relationship:</strong> {{ relationship.person1 }}{% if relationship.person2 %} & {{ relationship.person2 }}{% endif %}</p>
                                <p><strong>User:</strong> {{ users_by_id[rfi.user_id].name if users_by_id.get(rfi.user_id) else rfi.user_id }}</p>
                                <p><strong>Enforced by:</strong> {{ users_by_id[rfi.created_by].name if users_by_id.get(rfi.created_by) else rfi.created_by }}</p>
                                <p><small>ID: {{ rfi.id }}</small></p>
                            </div>
                            <div class="user-actions">
                                <button class="btn-reverse" onclick="confirmRemoveRelationshipForced('{{ rfi.user_id }}','{{ rfi.relationship_id }}')">Remove</button>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Pagination controls -->
                    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
                        {% for p in range(1, pagination.rfi_pages + 1) %}
                            <a href="{{ url_for('admin') }}?rfi_page={{ p }}" class="btn-secondary {% if p==pagination.rfi_page %}active-page{% endif %}" style="padding:6px 10px;">{{ p }}</a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>No forced identity reveals in relationships.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Topic Management -->
        <div id="topics" class="admin-section">
            <h3>üìù Topic Management</h3>
            <button class="btn-secondary" onclick="createTopic()">‚ûï Create New Topic</button>
            
            <div class="topics-list">
                {% for topic in topics %}
                <div class="topic-card">
                    <div class="topic-info">
                        <h4>
                            <span class="lock-dot {% if topic.is_locked %}locked-dot{% else %}unlocked-dot{% endif %}"></span>
                            {{ topic.name }}
                        </h4>
                        {% if topic.description %}
                            <p>{{ topic.description }}</p>
                        {% endif %}
                        <small>Created: {{ topic.created_at.strftime('%Y-%m-%d') }} | 
                               Active: {{ 'Yes' if topic.is_active else 'No' }}</small>
                    </div>
                    <div class="topic-actions">
                        <button class="btn-secondary" onclick="editTopic('{{ topic.id }}')">‚úèÔ∏è Edit</button>
                        <button class="btn-danger" onclick="deleteTopic('{{ topic.id }}')">üóëÔ∏è Delete</button>
                        <button class="btn-secondary" onclick="showLockModal('topic','{{ topic.id }}', '{{ topic.is_locked }}')">üîí Lock</button>
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No topics created yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Relationships Management -->
        <div id="relationships" class="admin-section">
            <h3>üíï Relationships Management</h3>
            
            <div class="topics-list">
                {% for relationship in relationships %}
                <div class="topic-card">
                    <div class="topic-info">
                        <h4>
                            <span class="lock-dot {% if relationship.is_locked %}locked-dot{% else %}unlocked-dot{% endif %}"></span>
                            {{ relationship.person1 }}{% if relationship.person2 %} & {{ relationship.person2 }}{% endif %}
                        </h4>
</style>
<style>
.lock-dot {
    display:inline-block;
    width:12px;
    height:12px;
    border-radius:50%;
    margin-right:6px;
    vertical-align:middle;
    border:1px solid #888;
}
.locked-dot {
    background:#e74c3c;
}
.unlocked-dot {
    background:#27ae60;
}
</style>
                        <p><strong>Category:</strong> {{ relationship.category }}</p>
                        {% if relationship.description %}
                            <p>{{ relationship.description }}</p>
                        {% endif %}
                        <small>Created: {{ relationship.created_at.strftime('%Y-%m-%d') }}</small>
                    </div>
                    <div class="topic-actions">
                        <button class="btn-danger" onclick="deleteRelationship('{{ relationship.id }}')">üóëÔ∏è Delete</button>
                        <button class="btn-secondary" onclick="showLockModal('relationship','{{ relationship.id }}', '{{ relationship.is_locked }}')">üîí Lock</button>
                    </div>
                </div>
                {% else %}
                <div class="empty-state">
                    <p>No relationships created yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Audit Log: Lock/Unlock Actions -->
        <div class="admin-section" id="auditlog">
            <h3>üîí Recent Lock/Unlock Actions</h3>
            <div class="admin-subsection">
                {% if audit_logs %}
                    <table style="width:100%;background:var(--black);color:#fff;border-radius:8px;">
                        <thead>
                            <tr style="background:var(--dark-blue);">
                                <th style="padding:6px;">Time</th>
                                <th style="padding:6px;">Admin</th>
                                <th style="padding:6px;">Action</th>
                                <th style="padding:6px;">Target</th>
                                <th style="padding:6px;">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for log in audit_logs %}
                            <tr>
                                <td style="padding:6px;">{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td style="padding:6px;">{{ users_by_id[log.admin_id].username if users_by_id.get(log.admin_id) else log.admin_id }}</td>
                                <td style="padding:6px;">{{ log.action }}</td>
                                <td style="padding:6px;">{{ log.target_type }} {{ log.target_id }}</td>
                                <td style="padding:6px;">{{ log.details }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="empty-state">No recent lock/unlock actions.</div>
                {% endif %}
            </div>
        </div>
        <div id="moderation" class="admin-section">
            <h3>üõ°Ô∏è Content Moderation</h3>
            <div class="moderation-stats">
                <div class="stat-card">
                    <h4>Total Messages</h4>
                    <p class="stat-number">{{ messages_count or 0 }}</p>
                </div>
                <div class="stat-card">
                    <h4>Active Users</h4>
                    <p class="stat-number">{{ approved_users|length }}</p>
                </div>
                <div class="stat-card">
                    <h4>Active Topics</h4>
                    <p class="stat-number">{{ topics|length }}</p>
                </div>
            </div>

            <div class="admin-subsection">
                <h4>Recent Reports</h4>
                <div class="empty-state">
                    <p>No reports at the moment.</p>
                    <small>This section would show reported messages and content for moderation.</small>
                </div>
            </div>

            <div class="admin-subsection">
                <h4>System Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <strong>Total Registrations:</strong> {{ (pending_users|length + approved_users|length + blocked_users|length) }}
                    </div>
                    <div class="stat-item">
                        <strong>Approval Rate:</strong> {{ "%.1f"|format((approved_users|length / (pending_users|length + approved_users|length + blocked_users|length) * 100) if (pending_users|length + approved_users|length + blocked_users|length) > 0 else 0) }}%
                    </div>
                    <div class="stat-item">
                        <strong>Block Rate:</strong> {{ "%.1f"|format((blocked_users|length / (pending_users|length + approved_users|length + blocked_users|length) * 100) if (pending_users|length + approved_users|length + blocked_users|length) > 0 else 0) }}%
                    </div>
                </div>
            </div>

            <div class="admin-subsection">
                <h4>Display Settings</h4>
                <p>Toggle whether active users are shown across the site.</p>
                <button id="toggle-active-users" class="btn-primary" data-show="{{ show_active_users|tojson }}">{{ 'Hide' if show_active_users else 'Show' }} Active Users</button>
            </div>
        </div>

        <!-- Identity Management Section -->
        <div id="identity" class="admin-section">
            <h3>üîì Identity Reveal Management</h3>
            <form id="identityForm" onsubmit="event.preventDefault(); sendIdentityAction();">
                <label for="topicSelect">Select Topic:</label>
                <select id="topicSelect" name="topic_id">
                    {% for topic in topics %}
                        <option value="{{ topic.id }}">{{ topic.name }}</option>
                    {% endfor %}
                </select>
                <label for="userSelect">Select User:</label>
                <select id="userSelect" name="user_id">
                    {% for user in approved_users %}
                        <option value="{{ user.id }}">{{ user.name }} ({{ user.username }})</option>
                    {% endfor %}
                </select>
                <button type="button" onclick="sendIdentityAction('force')">Reveal Identity</button>
                <button type="button" onclick="sendIdentityAction('reverse')">Reverse Identity</button>
            </form>
        </div>

        <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--medium-gray);">
            <a href="{{ url_for('login') }}">
                <button class="btn-secondary">‚Üê Back to Login</button>
            </a>
            <small style="display: block; margin-top: 10px; color: var(--light-gray);">
                Admin Panel ‚Ä¢ Gossip of Athi River Secondary School
            </small>
        </div>
    </div>

    <style>
        .admin-section {
            display: none;
        }
        .admin-section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }
        .admin-subsection {
            background: var(--dark-gray);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid var(--light-blue);
        }
        .user-card, .topic-card {
            background: var(--black);
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--medium-gray);
        }
        .user-info, .topic-info {
            flex: 1;
        }
        .user-actions, .topic-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--light-gray);
        }
        .moderation-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: var(--dark-blue);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--light-blue);
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .stat-item {
            background: var(--black);
            padding: 10px 15px;
            border-radius: 6px;
        }
        @media (max-width: 768px) {
            .user-card, .topic-card {
                flex-direction: column;
                align-items: stretch;
            }
            .user-actions, .topic-actions {
                margin-top: 10px;
                justify-content: center;
            }
        }
    </style>

    <script>
        // Get CSRF token from meta tag
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        // Common fetch with CSRF token
        function fetchWithCSRF(url, options = {}) {
            const csrfToken = getCSRFToken();
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            };
            
            return fetch(url, {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...(options.headers || {})
                }
            });
        }

        function showSection(sectionName) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }

        function approveUser(userId) {
            if (confirm('Are you sure you want to approve this user?')) {
                fetchWithCSRF('/api/approve_user/' + userId, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User approved successfully!');
                        location.reload();
                    } else {
                        alert('Error approving user: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error);
                });
            }
        }

        function rejectUser(userId) {
            if (confirm('Are you sure you want to reject this user?')) {
                fetchWithCSRF('/api/reject_user/' + userId, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User rejected successfully!');
                        location.reload();
                    } else {
                        alert('Error rejecting user: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error);
                });
            }
        }

        function blockUser(userId) {
            const reason = prompt('Enter reason for blocking this user:', 'Violation of community guidelines');
            if (reason !== null) {
                fetchWithCSRF('/api/block_user/' + userId, {
                    method: 'POST',
                    body: JSON.stringify({
                        reason: reason
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User blocked successfully!');
                        location.reload();
                    } else {
                        alert('Error blocking user: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error);
                });
            }
        }

        function unblockUser(userId) {
            if (confirm('Are you sure you want to unblock this user?')) {
                fetchWithCSRF('/api/unblock_user/' + userId, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User unblocked successfully!');
                        location.reload();
                    } else {
                        alert('Error unblocking user: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error);
                });
            }
        }

        function createTopic() {
            const name = prompt('Enter topic name:');
            if (name) {
                const description = prompt('Enter topic description (optional):');
                fetch('/api/create_topic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        description: description
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Topic created successfully!');
                        location.reload();
                    } else {
                        alert('Error creating topic: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
            }
        }

        function deleteTopic(topicId) {
            if (confirm('Are you sure you want to delete this topic? This will delete all messages in the topic.')) {
                fetch(`/api/delete_topic/${topicId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Topic deleted successfully!');
                            location.reload();
                        } else {
                            alert('Error deleting topic: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error);
                    });
            }
        }

        function deleteRelationship(relationshipId) {
            if (confirm('Are you sure you want to delete this relationship? This will delete all messages in the relationship chat.')) {
                fetch(`/api/delete_relationship/${relationshipId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Relationship deleted successfully!');
                            location.reload();
                        } else {
                            alert('Error deleting relationship: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error);
                    });
            }
        }

        // Lock modal functions
        function showLockModal(type, id, isLocked) {
            document.getElementById('lockModal').style.display = 'flex';
            document.getElementById('lock-type').value = type;
            document.getElementById('lock-id').value = id;
            // Clear inputs while we fetch
            document.getElementById('lock-password').value = '';
            document.getElementById('lock-message').value = '';
            const select = document.getElementById('lock-allowed-select');
            // Deselect all first
            Array.from(select.options).forEach(opt => opt.selected = false);
            document.getElementById('lock-action').innerText = isLocked === 'True' || isLocked === true ? 'Update Lock' : 'Set Lock';

            // Fetch current lock state to prefill allowed users and lock message
            fetchWithCSRF(`/api/admin/get_lock?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}`, { method: 'GET' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Prefill allowed users
                        if (Array.isArray(data.allowed) && data.allowed.length > 0) {
                            Array.from(select.options).forEach(opt => {
                                if (data.allowed.includes(opt.value) || data.allowed.includes(parseInt(opt.value))) {
                                    opt.selected = true;
                                }
                            });
                        }
                        // Prefill lock message
                        if (data.lock_message) document.getElementById('lock-message').value = data.lock_message;
                        // Indicate password exists (we don't reveal it)
                        const pwdInput = document.getElementById('lock-password');
                        if (data.has_password) {
                            pwdInput.placeholder = 'Password is set (leave blank to keep)';
                        } else {
                            pwdInput.placeholder = 'Enter a password to set lock (optional)';
                        }
                        document.getElementById('lock-action').innerText = data.is_locked ? 'Update Lock' : 'Set Lock';
                    } else {
                        // leave defaults
                    }
                })
                .catch(err => {
                    console.warn('Failed to fetch lock state', err);
                });
        }

        function hideLockModal() {
            document.getElementById('lockModal').style.display = 'none';
        }

        function submitLock() {
            // Deprecated: old submitLock(). Use enhanced handler bound to Save button.
        }

        // Enhanced submit handler
        document.addEventListener('DOMContentLoaded', function(){
            const saveBtn = document.getElementById('lock-save-btn');
            const filterInput = document.getElementById('lock-user-filter');
            const select = document.getElementById('lock-allowed-select');
            const selectVisibleBtn = document.getElementById('select-visible');
            const clearBtn = document.getElementById('clear-selection');
            const feedback = document.getElementById('lock-feedback');

            function setFeedback(msg, isError=true){
                if(!feedback) return;
                feedback.style.color = isError ? '#f55' : '#3c7';
                feedback.textContent = msg || '';
                feedback.style.display = msg ? 'block' : 'none';
            }

            // Filter options by text
            filterInput && filterInput.addEventListener('input', function(){
                const q = (this.value || '').toLowerCase().trim();
                Array.from(select.options).forEach(opt => {
                    const txt = (opt.textContent || opt.innerText || '').toLowerCase();
                    opt.style.display = (!q || txt.indexOf(q) !== -1) ? '' : 'none';
                });
            });

            // Select visible options
            selectVisibleBtn && selectVisibleBtn.addEventListener('click', function(){
                Array.from(select.options).forEach(opt => { if(opt.style.display !== 'none') opt.selected = true; });
            });

            // Clear selection
            clearBtn && clearBtn.addEventListener('click', function(){ Array.from(select.options).forEach(opt => opt.selected = false); });

            saveBtn && saveBtn.addEventListener('click', function(){
                const type = document.getElementById('lock-type').value;
                const id = document.getElementById('lock-id').value;
                const password = document.getElementById('lock-password').value;
                const allowed = Array.from(select.selectedOptions).map(opt => opt.value);
                const lockMessage = document.getElementById('lock-message').value;

                // Basic validation
                setFeedback('');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                fetchWithCSRF('/api/admin/set_lock', {
                    method: 'POST',
                    body: JSON.stringify({type: type, id: id, password: password, allowed: allowed, lock_message: lockMessage})
                }).then(r=>r.json()).then(data=>{
                    if (data.status === 'success') {
                        setFeedback('Lock updated', false);
                        setTimeout(()=>{ hideLockModal(); location.reload(); }, 700);
                    } else {
                        setFeedback(data.message || 'Error updating lock');
                    }
                }).catch(err => {
                    setFeedback(err.message || 'Network error');
                }).finally(()=>{ saveBtn.disabled = false; saveBtn.textContent = 'Save'; });
            });
        });

        function editTopic(topicId) {
            const name = prompt('Enter new topic name:');
            if (name) {
                const description = prompt('Enter new topic description (optional):');
                fetch('/api/edit_topic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic_id: topicId,
                        name: name,
                        description: description
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Topic updated successfully!');
                        location.reload();
                    } else {
                        alert('Error updating topic: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
            }
        }

        function handleIdentityAction(action, userIdOverride, topicIdOverride) {
            const topicId = topicIdOverride || document.getElementById('topicSelect').value;
            const userId = userIdOverride || document.getElementById('userSelect').value;

            if (!topicId || !userId) {
                alert('Please select both a topic and a user');
                return;
            }

            fetchWithCSRF('/api/force_identity', {
                method: 'POST',
                body: JSON.stringify({
                    topic_id: topicId,
                    user_id: userId,
                    action: action
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'success') {
                    showToast(data.message || 'Identity setting updated successfully!');
                    setTimeout(function(){ location.reload(); }, 900);
                } else {
                    showToast('Error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Error: ' + error);
            });
        }

        function handleRelationshipIdentityAction(action, userIdOverride, relationshipIdOverride) {
            const relationshipId = relationshipIdOverride || document.getElementById('relationshipSelect').value;
            const userId = userIdOverride || document.getElementById('relationshipUserSelect').value;

            if (!relationshipId || !userId) {
                alert('Please select both a relationship and a user');
                return;
            }

            fetchWithCSRF('/api/force_relationship_identity', {
                method: 'POST',
                body: JSON.stringify({
                    relationship_id: relationshipId,
                    user_id: userId,
                    action: action
                })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(function(data) {
                if (data.status === 'success') {
                    showToast(data.message || 'Identity setting updated successfully!');
                    setTimeout(function(){ location.reload(); }, 900);
                } else {
                    showToast('Error: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Error: ' + error);
            });
        }

        // Confirmation modal for forced reveals removal
        function confirmRemoveForced(userId, topicId) {
            const modal = document.getElementById('confirmModal');
            modal.dataset.type = 'topic';
            modal.dataset.userId = userId;
            modal.dataset.topicId = topicId;
            modal.style.display = 'flex';
            document.getElementById('confirmMessage').innerText = 'Remove forced identity reveal for this user in this topic?';
        }

        function confirmRemoveRelationshipForced(userId, relationshipId) {
            const modal = document.getElementById('confirmModal');
            modal.dataset.type = 'relationship';
            modal.dataset.userId = userId;
            modal.dataset.relationshipId = relationshipId;
            modal.style.display = 'flex';
            document.getElementById('confirmMessage').innerText = 'Remove forced identity reveal for this user in this relationship?';
        }

        function cancelConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function doConfirm() {
            const modal = document.getElementById('confirmModal');
            const userId = modal.dataset.userId;
            const type = modal.dataset.type;
            modal.style.display = 'none';

            if (type === 'topic') {
                const topicId = modal.dataset.topicId;
                handleIdentityAction('remove_force', userId, topicId);
            } else if (type === 'relationship') {
                const relationshipId = modal.dataset.relationshipId;
                handleRelationshipIdentityAction('remove_force', userId, relationshipId);
            }
        }

        function showToast(msg, timeout=2500) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, timeout);
        }

        function deleteRelationship(relationshipId) {
            if (confirm('Are you sure you want to delete this relationship?')) {
                fetchWithCSRF('/api/delete_relationship/' + relationshipId, {
                    method: 'POST'
                })
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data.status === 'success') {
                        alert('Relationship deleted successfully!');
                        location.reload();
                    } else {
                        alert('Error deleting relationship: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(function(error) {
                    alert('Error: ' + error);
                });
            }
        }
    </script>

    <!-- Lock modal -->
    <div id="lockModal" class="confirm-modal" style="display:none;">
        <div class="box" role="dialog" aria-modal="true" aria-labelledby="lock-action">
            <h3 id="lock-action">Set Lock</h3>
            <input type="hidden" id="lock-type">
            <input type="hidden" id="lock-id">

            <div style="margin:10px 0;text-align:left;">
                <label for="lock-password">Lock Password (leave blank to remove):</label>
                <input id="lock-password" type="password" style="width:100%;padding:8px;margin-top:6px;" placeholder="Enter password to protect this room">
            </div>

            <div style="margin:10px 0;text-align:left;">
                <label for="lock-user-filter">Filter users:</label>
                <input id="lock-user-filter" type="search" placeholder="Search users by name or username" style="width:100%;padding:8px;margin-top:6px;">
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <button type="button" class="btn-secondary" id="select-visible">Select Visible</button>
                    <button type="button" class="btn-secondary" id="clear-selection">Clear Selection</button>
                </div>
                <label style="display:block;margin-top:10px;">Allowed Users (multi-select):</label>
                <select id="lock-allowed-select" multiple style="width:100%;padding:8px;margin-top:6px;height:160px;">
                    {% for user in approved_users %}
                        <option value="{{ user.id }}">{{ user.name }} ({{ user.username }})</option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin:10px 0;text-align:left;">
                <label for="lock-message">Lock Message (shown to users when locked):</label>
                <textarea id="lock-message" style="width:100%;padding:8px;margin-top:6px;min-height:60px;" placeholder="Enter a message to show when users are locked out..."></textarea>
            </div>

            <div id="lock-feedback" style="min-height:22px;margin-top:8px;color:#f55;display:none"></div>

            <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
                <button class="btn-secondary" id="lock-save-btn">Save</button>
                <button class="btn-danger" onclick="hideLockModal()">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="box">
            <p id="confirmMessage">Are you sure?</p>
            <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
                <button class="btn-secondary" onclick="cancelConfirm()">Cancel</button>
                <button class="btn-reverse" onclick="doConfirm()">Yes, Remove</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>
</body>
</html>